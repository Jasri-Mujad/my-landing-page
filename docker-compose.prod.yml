# Production Docker Compose for Proxmox Home Server
# Uses pre-built images from GitHub Container Registry
# Includes Cloudflare Tunnel and Watchtower for auto-updates

services:
  # MongoDB Database
  mongo:
    image: mongo:7
    container_name: jasri-mongo
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - jasri-network

  # Express.js API Backend
  api:
    image: ghcr.io/jasri-mujad/my-landing-page/api:latest
    container_name: jasri-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGODB_URI=mongodb://mongo:27017/jasri-space
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - api_uploads:/app/uploads
    depends_on:
      - mongo
    networks:
      - jasri-network

  # React Vite Frontend (served by nginx)
  frontend:
    image: ghcr.io/jasri-mujad/my-landing-page/frontend:latest
    container_name: jasri-frontend
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - jasri-network

  # Cloudflare Tunnel - Zero Trust Access
  # No ports exposed to internet, traffic routes through Cloudflare
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - jasri-network

  # Watchtower - Auto-update containers when new images are pushed
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_RESTARTING=true
    networks:
      - jasri-network

networks:
  jasri-network:
    driver: bridge

volumes:
  mongo_data:
  api_uploads:
