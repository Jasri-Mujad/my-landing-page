name: CI/CD Pipeline

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]

env:
  REGISTRY: ghcr.io

jobs:
  # Backend API Tests
  test-api:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install API dependencies
        run: cd apps/api && npm install

      - name: Run API tests
        run: cd apps/api && npm test

  # Frontend Tests
  test-frontend:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Frontend dependencies
        run: cd apps/jasri-space && npm install

      - name: Run Frontend tests
        run: cd apps/jasri-space && npm test

  # Security Scanning with Trivy
  security:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner (filesystem)
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          severity: 'CRITICAL,HIGH'
          exit-code: '0'  # Don't fail build, just report (change to '1' to enforce)

  # Build job - only runs if all checks pass
  build-and-push:
    needs: [test-api, test-frontend, security]
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Downcase REPO variable
        run: |
          echo "REPO=${GITHUB_REPOSITORY,,}" >>${GITHUB_ENV}

      - name: Log in to Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Build and push API image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/api
          push: true
          tags: |
            ghcr.io/${{ env.REPO }}/api:latest
            ghcr.io/${{ env.REPO }}/api:${{ github.sha }}
      
      - name: Build and push Frontend image
        uses: docker/build-push-action@v5
        with:
          context: ./apps/jasri-space
          push: true
          build-args: |
            VITE_API_URL=https://api.jasricozyspace.com
          tags: |
            ghcr.io/${{ env.REPO }}/frontend:latest
            ghcr.io/${{ env.REPO }}/frontend:${{ github.sha }}

  # Email Notification on Failure
  notify-failure:
    if: failure()
    needs: [test-api, test-frontend, security, build-and-push]
    runs-on: ubuntu-latest
    
    steps:
      - name: Send failure notification email
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: smtp.gmail.com
          server_port: 587
          secure: true
          username: ${{ secrets.SMTP_EMAIL }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: "‚ùå CI/CD Pipeline Failed - ${{ github.repository }}"
          to: ${{ secrets.NOTIFICATION_EMAIL }}
          from: "CI/CD Bot <${{ secrets.SMTP_EMAIL }}>"
          body: |
            üö® Pipeline Failure Alert
            
            Repository: ${{ github.repository }}
            Branch: ${{ github.ref_name }}
            Commit: ${{ github.sha }}
            Author: ${{ github.actor }}
            
            View the failed run:
            ${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}
            
            ---
            This is an automated message from GitHub Actions.

