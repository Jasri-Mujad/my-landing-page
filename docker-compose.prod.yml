# Production Docker Compose for Proxmox Home Server
# Uses pre-built images from GitHub Container Registry
# Includes Cloudflare Tunnel and Watchtower for auto-updates

services:
  # MongoDB Database
  mongo:
    image: mongo:7
    container_name: jasri-mongo
    restart: unless-stopped
    volumes:
      - mongo_data:/data/db
    networks:
      - jasri-network

  # Express.js API Backend
  api:
    image: ghcr.io/jasri-mujad/my-landing-page/api:latest
    container_name: jasri-api
    restart: unless-stopped
    environment:
      - NODE_ENV=production
      - PORT=5000
      - MONGODB_URI=mongodb://mongo:27017/jasri-space
      - JWT_SECRET=${JWT_SECRET}
    volumes:
      - api_uploads:/app/uploads
    depends_on:
      - mongo
    networks:
      - jasri-network

  # React Vite Frontend (served by nginx)
  frontend:
    image: ghcr.io/jasri-mujad/my-landing-page/frontend:latest
    container_name: jasri-frontend
    restart: unless-stopped
    depends_on:
      - api
    networks:
      - jasri-network

  # Cloudflare Tunnel - Zero Trust Access
  # No ports exposed to internet, traffic routes through Cloudflare
  cloudflared:
    image: cloudflare/cloudflared:latest
    container_name: cloudflared
    restart: unless-stopped
    command: tunnel run
    environment:
      - TUNNEL_TOKEN=${CLOUDFLARE_TUNNEL_TOKEN}
    networks:
      - jasri-network

  # Watchtower - Auto-update containers when new images are pushed
  watchtower:
    image: containrrr/watchtower
    container_name: watchtower
    restart: unless-stopped
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ~/.docker/config.json:/config.json:ro
    environment:
      - WATCHTOWER_CLEANUP=true
      - WATCHTOWER_POLL_INTERVAL=300
      - WATCHTOWER_INCLUDE_RESTARTING=true
      - DOCKER_API_VERSION=1.44
    networks:
      - jasri-network

  # ============================================
  # MONITORING STACK
  # ============================================

  # Prometheus - Metrics Collection
  prometheus:
    image: prom/prometheus:latest
    container_name: prometheus
    restart: unless-stopped
    volumes:
      - ./monitoring/prometheus.yml:/etc/prometheus/prometheus.yml:ro
      - prometheus_data:/prometheus
    command:
      - '--config.file=/etc/prometheus/prometheus.yml'
      - '--storage.tsdb.path=/prometheus'
      - '--web.enable-lifecycle'
    ports:
      - "9090:9090"
    networks:
      - jasri-network

  # Grafana - Dashboards & Visualization
  grafana:
    image: grafana/grafana:latest
    container_name: grafana
    restart: unless-stopped
    environment:
      - GF_SECURITY_ADMIN_USER=admin
      - GF_SECURITY_ADMIN_PASSWORD=${GRAFANA_PASSWORD:-admin123}
      - GF_USERS_ALLOW_SIGN_UP=false
    volumes:
      - grafana_data:/var/lib/grafana
    ports:
      - "3001:3000"
    depends_on:
      - prometheus
    networks:
      - jasri-network

  # Uptime Kuma - Uptime Monitoring & Alerts
  uptime-kuma:
    image: louislam/uptime-kuma:latest
    container_name: uptime-kuma
    restart: unless-stopped
    volumes:
      - uptime_kuma_data:/app/data
    ports:
      - "3002:3001"
    networks:
      - jasri-network

  # ============================================
  # BACKUP SERVICE
  # ============================================

  # MongoDB Backup - Daily automated backups
  mongo-backup:
    image: mongo:7
    container_name: mongo-backup
    restart: "no"
    entrypoint: /bin/bash
    command:
      - -c
      - |
        echo "Starting backup..."
        mongodump --host mongo --port 27017 --db jasri-space --out /backups/$(date +%Y-%m-%d_%H-%M-%S)
        echo "Backup complete. Cleaning old backups..."
        find /backups -type d -mtime +7 -exec rm -rf {} + 2>/dev/null || true
        echo "Done."
    volumes:
      - mongo_backups:/backups
    depends_on:
      - mongo
    networks:
      - jasri-network
    # Run manually or via cron on host: docker compose run --rm mongo-backup

networks:
  jasri-network:
    driver: bridge

volumes:
  mongo_data:
  api_uploads:
  prometheus_data:
  grafana_data:
  uptime_kuma_data:
  mongo_backups:

